<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>나홀로 떠나는 전주여행</title>

  <!-- TailwindCSS (CDN) 예시 -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 1) Leaflet CSS (integrity 제거) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    /* 페이지 전체를 100% 높이로 사용하기 위해 body/html에 높이 지정 */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    /* 지도가 삽입될 div 높이 지정 (예: 전체 높이의 50%를 지도에 배정) */
    #map {
      height: 400px; /* 필요에 따라 높이 조정 */
      width: 100%;
      margin-top: 1rem;
    }
  </style>
</head>
<body class="bg-gray-100">

  <!-- 상단 헤더 -->
  <header class="bg-white shadow-md py-4 mb-6">
    <div class="container mx-auto px-4 text-center">
      <h1 class="text-3xl font-bold text-green-600">나홀로 떠나는 전주여행</h1>
    </div>
  </header>

  <main class="container mx-auto px-4">
    <!-- 언어 선택 및 버튼 -->
    <section class="bg-white p-6 rounded-lg shadow mb-6">
      <h2 class="text-xl font-semibold mb-4">나만의 전주여행 일정 만들기</h2>

      <label for="languageSelect" class="block mb-2">언어 선택:</label>
      <select id="languageSelect" class="border border-gray-300 rounded px-3 py-2 mb-4 w-full max-w-xs">
        <option value="ko">한국어</option>
        <option value="en">영어</option>
      </select>

      <button
        id="generateBtn"
        class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded w-full max-w-xs"
      >
        여행 일정 생성하기
      </button>
    </section>

    <!-- 결과 영역: 초기에 hidden 상태 -->
    <section id="itineraryResult" class="hidden bg-white p-6 rounded-lg shadow mb-6">
      <h2 class="text-xl font-semibold mb-4">생성된 일정</h2>
      <div id="itineraryContent" class="prose text-gray-800 whitespace-pre-wrap">
        <!-- 버튼 클릭 시 일정 텍스트가 여기에 들어옵니다. -->
      </div>

      <!-- 지도 영역: 버튼 클릭 후에 보여집니다 -->
      <div id="map" class="mt-6"></div>
    </section>

    <!-- 추천 여행지/후기/기타 컨텐츠 (블로그 형식) -->
    <section class="bg-white p-6 rounded-lg shadow mb-6">
      <h2 class="text-xl font-semibold mb-4">추천 여행지</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- 예시 카드 3개 -->
        <div class="bg-gray-50 rounded-lg overflow-hidden shadow hover:shadow-lg transition">
          <img
            src="https://via.placeholder.com/400x240?text=한옥마을"
            alt="전주 한옥마을"
            class="w-full h-48 object-cover"
          />
          <div class="p-4">
            <h3 class="text-lg font-semibold">전주 한옥마을</h3>
            <p class="text-gray-600 mt-2">조선시대 전통 가옥이 모여있는 대표 관광지</p>
          </div>
        </div>

        <div class="bg-gray-50 rounded-lg overflow-hidden shadow hover:shadow-lg transition">
          <img
            src="https://via.placeholder.com/400x240?text=전동성당"
            alt="전동성당"
            class="w-full h-48 object-cover"
          />
          <div class="p-4">
            <h3 class="text-lg font-semibold">전동성당</h3>
            <p class="text-gray-600 mt-2">고딕 양식의 아름다운 성당, 야경이 유명</p>
          </div>
        </div>

        <div class="bg-gray-50 rounded-lg overflow-hidden shadow hover:shadow-lg transition">
          <img
            src="https://via.placeholder.com/400x240?text=남부시장"
            alt="남부시장"
            class="w-full h-48 object-cover"
          />
          <div class="p-4">
            <h3 class="text-lg font-semibold">남부시장</h3>
            <p class="text-gray-600 mt-2">전북 대표 재래시장, 다양한 전통 먹거리</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- 2) Leaflet JS (integrity 제거, defer 사용) -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
    defer
  ></script>

  <!-- 3) 사용자 스크립트: API 호출 및 지도 표시 -->
  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      // (1) 백엔드 도메인(배포된 URL) / 로컬 테스트 도메인
      const BACKEND_URL = 'https://jeonju-backend.onrender.com';

      // (2) Leaflet 지도 초기화
      let map = L.map('map').setView([35.8180, 127.1470], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // (3) 경로(마커 + 폴리라인) 그려주는 함수
      function plotRoute(coordsArray) {
        coordsArray.forEach((coord, idx) => {
          const marker = L.marker(coord).addTo(map);
          marker.bindPopup(`경유 ${idx + 1}`);
        });
        L.polyline(coordsArray, { color: 'blue', weight: 4 }).addTo(map);
      }

      // (4) 버튼 클릭 시 백엔드 /api/generate 호출
      const btn = document.getElementById('generateBtn');
      btn.addEventListener('click', async () => {
        const resultSection = document.getElementById('itineraryResult');
        const contentDiv = document.getElementById('itineraryContent');
        // 결과 영역 보여주기
        resultSection.classList.remove('hidden');
        contentDiv.innerHTML = '<p class="text-gray-700">여행 일정을 생성 중입니다...</p>';

        try {
          // (A) 언어 선택값 가져오기
          const lang = document.getElementById('languageSelect').value;

          // (B) 백엔드로 POST 요청
          const res = await fetch(`${BACKEND_URL}/api/generate`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              startDate: new Date().toISOString().split('T')[0], // 예시로 오늘 날짜 사용
              days: 3,
              language: lang
            })
          });

          if (!res.ok) {
            throw new Error(`백엔드 오류: ${res.status} ${res.statusText}`);
          }

          const json = await res.json();
          const planText = json.plan || '';

          // (C) 일정 텍스트 화면에 출력
          contentDiv.innerHTML = '<pre class="whitespace-pre-wrap">' + planText + '</pre>';

          // (D) (테스트용) 샘플 좌표로 지도에 경로 그리기
          //    실제 배포 시에는 GPT 응답에서 장소 이름만 가져와서 Geocoding API(예: Nominatim)로 위도/경도 얻는 로직을 추가해야 합니다.
          const sampleCoords = [
            [35.8190, 127.1480], // 한옥마을 대략 좌표
            [35.8152, 127.1470], // 전동성당 대략 좌표
            [35.8155, 127.1447]  // 남부시장 대략 좌표
          ];
          plotRoute(sampleCoords);

          // 지도가 hidden 상태에서 보이는 상태로 바뀌면, 사이즈를 재계산해야 올바르게 표시됩니다.
          setTimeout(() => {
            map.invalidateSize();
          }, 200);

        } catch (err) {
          console.error(err);
          contentDiv.innerHTML = `<p class="text-red-600">일정 생성에 실패했습니다: ${err.message}</p>`;
        }
      });
    });
  </script>
</body>
</html>
