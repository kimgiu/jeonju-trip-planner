<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>나홀로 떠나는 전주여행 - 일정 및 지도</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body { background: #f7fafc; font-family: 'Noto Sans KR', sans-serif; }
    .main-wrap { max-width: 1200px; margin: 0 auto; padding: 30px 0; }
    .flex { display: flex; gap: 32px; }
    #map { width: 480px; min-width:320px; height: 660px; border-radius: 16px; border: 2px solid #eee; box-sizing: border-box; }
    .itinerary-list { flex: 1; }
    .itinerary-day { background: #fff; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 2px 8px #0002; padding: 18px 24px; }
    .itinerary-day h3 { font-size: 1.3rem; margin: 0 0 10px 0; color: #25863b; }
    .itinerary-item { display: flex; align-items: flex-start; gap: 20px; margin-bottom: 14px; }
    .marker-idx { width:32px; height:32px; border-radius:50%; background:#2ec46d; color:#fff; text-align:center; line-height:32px; font-weight:bold; font-size:1.2rem; margin-top:3px;}
    .detail-card { flex:1; background:#f6fff6; border-radius:7px; padding:10px 14px; }
    .place { font-weight: bold; font-size:1.05em; }
    .resto { color:#369; margin-top:2px;}
    .stay { color:#ad5f00; margin-top:2px;}
    .toolbar { display: flex; gap: 14px; margin-bottom: 22px;}
    .toolbar button { background:#179c4a; color:#fff; font-weight:600; border:none; border-radius:6px; padding:7px 18px; font-size:1em; cursor:pointer; transition:0.18s;}
    .toolbar button:hover { background:#127c3a;}
    @media (max-width: 900px) {
      .flex { flex-direction: column; }
      #map { width: 100%; height: 350px; }
    }
    @media print {
      .toolbar, #map { display:none !important; }
      .main-wrap { max-width: 100%; }
      body { background:#fff; }
    }
  </style>
</head>
<body>
<div class="main-wrap">
  <header>
    <h1 style="font-size:2rem; font-weight:700; color:#179c4a; margin-bottom:26px;">나홀로 떠나는 전주여행</h1>
    <div class="toolbar">
      <button onclick="downloadPDF()">PDF 저장</button>
      <button onclick="sharePage()">공유하기</button>
      <button onclick="window.print()">인쇄하기</button>
    </div>
  </header>
  <div class="flex">
    <!-- 지도 -->
    <div id="map"></div>
    <!-- 일정 리스트 -->
    <div class="itinerary-list" id="itinerary-list">
      <!-- 일정카드가 JS로 추가됨 -->
    </div>
  </div>
</div>

<!-- Leaflet.js -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const PLACES = [
  {id:'hanok', name:'전주 한옥마을', type:'place', lat:35.815924, lng:127.153288},
  {id:'gyonggijeon', name:'경기전', type:'place', lat:35.815893, lng:127.150642},
  {id:'jeondong', name:'전동성당', type:'place', lat:35.814855, lng:127.148799},
  {id:'namboo', name:'남부시장', type:'place', lat:35.813218, lng:127.150408},
  {id:'jaman', name:'자만벽화마을', type:'place', lat:35.814244, lng:127.156039},
  {id:'omokdae', name:'오목대', type:'place', lat:35.817579, lng:127.151926},
];
const RESTAURANTS = [
  {name:'베테랑 칼국수', lat:35.8156, lng:127.1541, menu:'칼국수', price:'7,000원', address:'전주시 완산구 경기전길 135', phone:'063-285-9898'},
  {name:'삼백집', lat:35.8164, lng:127.1542, menu:'콩나물국밥', price:'9,000원', address:'전주시 완산구 전동3가 2-1', phone:'063-284-2227'},
  {name:'왱이콩나물국밥', lat:35.8169, lng:127.1547, menu:'콩나물국밥', price:'9,000원', address:'전주시 완산구 경기전길 20', phone:'063-287-6980'},
  {name:'중앙회관', lat:35.8139, lng:127.1485, menu:'비빔밥', price:'13,000원', address:'전주시 완산구 전동 2-1', phone:'063-232-8912'},
];
const HOTELS = [
  {grade:'저가', name:'스테이호텔', lat:35.8146, lng:127.1565, price:'40,000원~', address:'전주시 완산구 자만동 123-1', phone:'063-272-1111'},
  {grade:'중가', name:'라한호텔', lat:35.8138, lng:127.1466, price:'110,000원~', address:'전주시 완산구 전동 40-1', phone:'063-230-7000'},
  {grade:'고가', name:'라마다호텔', lat:35.8174, lng:127.1502, price:'180,000원~', address:'전주시 완산구 한옥마을로 94', phone:'063-281-8888'},
];

function generatePlan(startDate="2025-07-01", days=2) {
  const itinerary = [];
  const schedule = [
    [
      { time:'09:00', type:'place', ref:PLACES[0] },
      { time:'11:00', type:'place', ref:PLACES[1] },
      { time:'12:00', type:'food', ref:RESTAURANTS[0] },
      { time:'13:00', type:'place', ref:PLACES[2] },
      { time:'15:00', type:'place', ref:PLACES[3] },
      { time:'18:00', type:'food', ref:RESTAURANTS[1] },
      { time:'20:00', type:'stay', ref:HOTELS[1] },
    ],
    [
      { time:'09:00', type:'place', ref:PLACES[4] },
      { time:'11:00', type:'place', ref:PLACES[5] },
      { time:'12:00', type:'food', ref:RESTAURANTS[3] },
      { time:'15:00', type:'place', ref:PLACES[0] },
    ],
  ];
  for(let d=0; d<days; d++){
    const date = new Date(startDate);
    date.setDate(date.getDate()+d);
    itinerary.push({
      day: d+1,
      date: date.toISOString().slice(0,10),
      slots: schedule[d] || [],
    });
  }
  return itinerary;
}

const itinerary = generatePlan();

const map = L.map('map').setView([35.815924, 127.153288], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

function renderItinerary(list) {
  const cont = document.getElementById('itinerary-list');
  cont.innerHTML = '';
  let markerIdx = 1;
  list.forEach(day=>{
    const d = document.createElement('div');
    d.className = 'itinerary-day';
    d.innerHTML = `<h3>${day.day}일차 <span style="font-size:.95em;color:#666">(${day.date})</span></h3>`;
    day.slots.forEach(slot=>{
      let icon = '';
      let desc = '';
      if(slot.type==='place'){
        icon = `<span class="marker-idx">${markerIdx}</span>`;
        desc = `<div class="detail-card"><div class="place">${slot.ref.name}</div></div>`;
      } else if(slot.type==='food'){
        icon = `<span class="marker-idx" style="background:#1e90ff;">🍴</span>`;
        desc = `<div class="detail-card resto">
          <div class="place">${slot.ref.name} <span style="font-size:.9em">(${slot.ref.menu})</span></div>
          <div>대표메뉴: <b>${slot.ref.menu}</b> <span style="color:#555">(${slot.ref.price})</span></div>
          <div class="text-xs" style="font-size:.85em">주소: ${slot.ref.address}<br>전화: ${slot.ref.phone}</div>
        </div>`;
      } else if(slot.type==='stay'){
        icon = `<span class="marker-idx" style="background:#ad5f00;">🏨</span>`;
        desc = `<div class="detail-card stay">
          <div class="place">${slot.ref.grade} | ${slot.ref.name}</div>
          <div>가격: <b>${slot.ref.price}</b></div>
          <div style="font-size:.85em">주소: ${slot.ref.address}<br>전화: ${slot.ref.phone}</div>
        </div>`;
      }
      d.innerHTML += `<div class="itinerary-item">${icon}<span style="width:80px;">${slot.time}</span>${desc}</div>`;
      markerIdx++;
    });
    cont.appendChild(d);
  });
}

function plotItinerary(list) {
  let prevLatLngs = [];
  let markerIdx = 1;
  list.forEach((day, di)=>{
    let latlngs = [];
    day.slots.forEach(slot=>{
      if(slot.ref.lat && slot.ref.lng){
        latlngs.push([slot.ref.lat, slot.ref.lng]);
        let marker = L.marker([slot.ref.lat, slot.ref.lng]).addTo(map)
          .bindPopup(`${slot.time} ${slot.ref.name}`);
        marker._icon.innerHTML = `<div style="position:relative;left:7px;top:3px;font-size:1.2em;color:#fff;">${markerIdx}</div>`;
        markerIdx++;
      }
    });
    if(latlngs.length>=2) {
      L.polyline(latlngs, {color:['#198754','#0d6efd','#e34c4c'][di%3], weight:4, opacity:0.8}).addTo(map);
    }
    prevLatLngs = prevLatLngs.concat(latlngs);
  });
  if(prevLatLngs.length>0){
    map.fitBounds(prevLatLngs, {padding:[40,40]});
  }
}

renderItinerary(itinerary);
plotItinerary(itinerary);

/* ==========================
  PDF저장/공유/인쇄 JS 추가
============================= */
function downloadPDF() {
  // 일정리스트만 캡처
  const element = document.getElementById('itinerary-list');
  html2canvas(element).then(canvas=>{
    const imgData = canvas.toDataURL('image/png');
    const pdf = new window.jspdf.jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4'
    });
    // 이미지 A4넣기 (비율자동)
    const pageWidth = 210, pageHeight = 297;
    const imgProps = pdf.getImageProperties(imgData);
    const imgWidth = pageWidth - 20;
    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
    pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
    pdf.save('전주여행일정.pdf');
  });
}

// 공유 (웹공유 or 링크복사)
function sharePage() {
  if (navigator.share) {
    navigator.share({
      title: document.title,
      url: window.location.href
    });
  } else {
    // 복사
    const t = document.createElement('textarea');
    t.value = window.location.href;
    document.body.appendChild(t);
    t.select();
    document.execCommand('copy');
    document.body.removeChild(t);
    alert('주소가 복사되었습니다! 친구에게 붙여넣기 하세요.');
  }
}
</script>
</body>
</html>
